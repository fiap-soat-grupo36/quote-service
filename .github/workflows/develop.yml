name: Develop - CI/CD

on:
  push:
    branches: [develop]

jobs:
  build-and-test:
    needs: service-readiness
    if: ${{ needs.service-readiness.outputs.ready == 'true' }}
    permissions:
      contents: read
      packages: read
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-java-ci.yml@main
    with:
      java_version: '21'
      skip_checkstyle: true
      build_command: 'mvn -B -ntp -U clean verify'
      upload_jacoco_reports: true
      jacoco_artifact_name: 'jacoco-reports-${{ github.run_id }}'
      jacoco_report_path: '**/target/site/jacoco/jacoco.xml'
    secrets: inherit

  sonar:
    needs: [service-readiness, build-and-test]
    if: ${{ needs.service-readiness.outputs.ready == 'true' }}
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-sonar-java.yml@main
    with:
      java_version: '21'
      sonar_org: 'fiap-soat-grupo36'
      sonar_project_key: 'fiap-soat-grupo36_quote-service'
      maven_skip_tests: true
      download_jacoco_artifacts: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  docker:
    needs: [service-readiness, build-and-test, sonar]
    if: ${{ needs.service-readiness.outputs.ready == 'true' }}
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-dockerhub.yml@main
    with:
      modules: '["quote-service"]'
      dockerfile_pattern: './Dockerfile'
      registry_namespace: 'fiapsoatgrupo36'
      tag_strategy: 'both'
      push_images: true
    secrets: inherit

  #verify-infrastructure:
  #  uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-terraform.yml@main
  #  with:
  #    workspace: dev
  #    environment: dev
  #    working_directory: ./infra
  #    auto_apply: false
  #    localstack_pod: fiap
  #  secrets:
  #    LOCALSTACK_AUTH_TOKEN: ${{ secrets.LOCALSTACK_AUTH_TOKEN }}
#
  #deploy-dev:
  #  needs: [docker,verify-infrastructure]
  #  if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
  #  uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-terraform.yml@main
  #  with:
  #    workspace: dev
  #    environment: dev
  #    working_directory: ./infra
  #    auto_apply: true
  #    localstack_pod: fiap
  #  secrets:
  #    LOCALSTACK_AUTH_TOKEN: ${{ secrets.LOCALSTACK_AUTH_TOKEN }}

  create-pr-to-main:
    permissions:
      contents: read
      pull-requests: write
    #needs: deploy-dev
    uses: fiap-soat-grupo36/reusable-actions/.github/workflows/_reusable-create-pr.yml@main
    with:
      base: main
      head: develop
      title: "Promote develop to main - ${{ github.sha }}"
      body: |
        ## üéØ Ready for Production Deployment
        
        **Environment:** Development ‚Üí Production
        **Commit:** `${{ github.sha }}`
        **Deployed to Dev:** ‚úÖ Successful
        
        **Environment:** Development ‚Üí Production
        **Commit:** `${{ github.sha }}`

        ### ‚úÖ CI/CD Status
        - ‚úÖ Unit tests passed
        - ‚úÖ Code coverage analyzed
        - ‚úÖ SonarCloud quality gate passed
        - ‚úÖ Docker image published
        - ‚úÖ Deployed successfully to DEV
        
        ### üì¶ Docker Image
        - **Image:** `fiapsoatgrupo36/quote-service:develop-${{ github.sha }}`
        
        ### üîç Review Checklist
        - [ ] All features tested in DEV
        - [ ] No critical bugs reported
        - [ ] Performance validated
        - [ ] Security review completed
        
        Ready for production deployment! üöÄ
      draft: false

